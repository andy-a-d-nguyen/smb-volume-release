#!/bin/bash

set -e

echo "Installing smb server..."
(
flock -x 200
apt-get update
apt-get install -y samba
) 200>/var/vcap/data/dpkg.lock

if [ "$(pidof -s smbd)" != "" ]; then
  service smbd stop
fi

echo "Creating SMB user..."
id -u <%= p("username") %> &>/dev/null || useradd <%= p("username") %> --group vcap
smbpasswd -a <%= p("username") %> -s <<EOF
<%= p("password") %>
<%= p("password") %>
EOF

sed -in '1h; 1!H; ${ g; s/#start-vol-config.*end-vol-config//p}' /etc/samba/smb.conf

echo "#start-vol-config" >> /etc/samba/smb.conf
for i in $(seq 1 3);
  do
    echo "Configuring vol${i} share..."
    mkdir -p <%= p("export_root_path") %>/export/vol${i}
    chmod 775 <%= p("export_root_path") %>/export/vol${i}
    chown root:vcap <%= p("export_root_path") %>/export/vol${i}

  cat << EOF >> /etc/samba/smb.conf
[vol${i}]
   path = <%= p("export_root_path") %>/export/vol${i}
   hosts allow = <%= p("export_cidr") %>
   valid users = @vcap
   browseable = no
   guest ok = no
   read only = no
   create mask = 0755
EOF
done
echo "#end-vol-config" >> /etc/samba/smb.conf

echo "Installed smb server"
exit 0
