#!/bin/bash

set -e

echo "Installing smb server..."
(
flock -x 200
apt-get update
apt-get install -y samba
) 200>/var/vcap/data/dpkg.lock

if [ "$(pidof -s smbd)" != "" ]; then
  service smbd stop
fi

echo "Creating SMB user..."
id -u <%= p("username") %> &>/dev/null || useradd <%= p("username") %> --group vcap
smbpasswd -a <%= p("username") %> -s <<EOF
<%= p("password") %>
<%= p("password") %>
EOF

sed -i 's/log file\s=.*$/log file = \/var\/vcap\/sys\/log\/smbtestserver\/smbtestserver\.stdout\.log/' /etc/samba/smb.conf

if [[ $(grep start-vol-config /etc/samba/smb.conf) ]]; then 
 sed -n '1h; 1!H; ${ g; s/#start-vol-config.*end-vol-config//p}' /etc/samba/smb.conf > /tmp/smb.conf
else
 cp /etc/samba/smb.conf /tmp/smb.conf
fi
echo '#start-vol-config' >> /tmp/smb.conf
for i in $(seq 1 3);
  do
    echo "Configuring vol${i} share..."
    mkdir -p <%= p("export_root_path") %>/export/vol${i}
    chmod 775 <%= p("export_root_path") %>/export/vol${i}
    chown root:vcap <%= p("export_root_path") %>/export/vol${i}

  cat << EOF >> /tmp/smb.conf
[vol${i}]
   path = <%= p("export_root_path") %>/export/vol${i}
   hosts allow = <%= p("export_cidr") %>
   valid users = @vcap
   browseable = no
   guest ok = no
   read only = no
   create mask = 0755
EOF
done
echo '#end-vol-config' >> /tmp/smb.conf

mv /tmp/smb.conf /etc/samba/smb.conf

echo "Installed smb server"
exit 0
